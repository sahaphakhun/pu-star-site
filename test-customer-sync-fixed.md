# ทดสอบระบบการซิงค์ชื่อลูกค้า (แก้ไขแล้ว)

## การแก้ไขที่ทำไปแล้ว

### 1. แก้ไขปัญหาข้อผิดพลาด 500 ใน API `/api/admin/customers`
- **ปัญหา**: ฟังก์ชัน `calculateCustomerAnalytics` ใช้ `order.orderDate` แต่โมเดล Order ใช้ `order.createdAt`
- **การแก้ไข**: เปลี่ยนจาก `order.orderDate` เป็น `order.createdAt` ในฟังก์ชัน `calculateCustomerAnalytics`
- **ไฟล์**: `src/utils/customerAnalytics.ts`

### 2. เพิ่มการจัดการข้อผิดพลาดที่ดีขึ้น
- **เพิ่ม try-catch** ในส่วนการดึงข้อมูลจากฐานข้อมูล
- **เพิ่ม try-catch** ในส่วนการสร้างสถิติลูกค้า
- **เพิ่ม try-catch** ในส่วนการส่งออกข้อมูล CSV
- **ไฟล์**: `src/app/api/admin/customers/route.ts`

### 3. ปรับปรุงฟังก์ชันการซิงค์ชื่อลูกค้า
- **เพิ่มฟังก์ชัน** `normalizePhoneNumber()` สำหรับแปลงเบอร์โทรศัพท์
- **เพิ่มฟังก์ชัน** `isSamePhoneNumber()` สำหรับตรวจสอบเบอร์โทรศัพท์
- **ปรับปรุงฟังก์ชัน** `syncUserNameFromFirstOrder()` ให้ค้นหาจากเบอร์โทรศัพท์
- **รองรับเบอร์โทรศัพท์** ทั้งสองรูปแบบ (0 และ 66)
- **ไฟล์**: `src/utils/userNameSync.ts`

### 4. ปรับปรุงหน้าออเดอร์
- **เพิ่มการแสดงชื่อลูกค้า** ทั้งสองแบบ: ชื่อจากฟอร์มสั่งซื้อและชื่อจากระบบ
- **แสดงชื่อลูกค้าจากระบบ** ในรูปแบบ badge สีน้ำเงิน
- **เพิ่มฟังก์ชัน** สำหรับดึงข้อมูลลูกค้าจากระบบ
- **ไฟล์**: `src/app/(shop)/admin/orders/page.tsx`

### 5. ปรับปรุง API endpoint
- **เพิ่ม action** `getCustomersByIds` สำหรับดึงข้อมูลลูกค้าตาม ID
- **ปรับปรุง action** `syncCustomerName` ให้ใช้เบอร์โทรศัพท์
- **ไฟล์**: `src/app/api/admin/customers/route.ts`

### 6. ปรับปรุงหน้าลูกค้า
- **แก้ไขฟังก์ชัน** `handleSyncCustomerName` ให้ส่งเบอร์โทรศัพท์
- **ไฟล์**: `src/app/(shop)/admin/customers/page.tsx`

## วิธีการทำงานใหม่

### การซิงค์ชื่อลูกค้า
1. เมื่อกดปุ่ม "ซิงค์ชื่อ" ในหน้าลูกค้า ระบบจะส่งเบอร์โทรศัพท์ของลูกค้าไปยัง API
2. ระบบจะค้นหาออเดอร์แรกของลูกค้าจากเบอร์โทรศัพท์ (รองรับทั้งรูปแบบ 0 และ 66)
3. หากพบออเดอร์และมีชื่อลูกค้าในออเดอร์ ระบบจะอัปเดตชื่อลูกค้าในระบบ
4. หากไม่พบออเดอร์หรือไม่มีชื่อลูกค้าในออเดอร์ ระบบจะแสดงข้อความแจ้งเตือน

### การแสดงชื่อลูกค้าในหน้าออเดอร์
1. ระบบจะแสดงชื่อลูกค้าจากฟอร์มสั่งซื้อเป็นชื่อหลัก
2. หากออเดอร์มี userId และมีข้อมูลลูกค้าในระบบ ระบบจะแสดงชื่อลูกค้าจากระบบในรูปแบบ badge สีน้ำเงิน
3. ชื่อลูกค้าจากระบบจะแสดงในรูปแบบ "ชื่อในระบบ: [ชื่อลูกค้า]"

## การทดสอบ

### ทดสอบการซิงค์ชื่อลูกค้า
1. ไปที่หน้าลูกค้า (`/admin/customers`)
2. ค้นหาลูกค้าที่มีชื่อเป็น "ลูกค้า"
3. กดปุ่ม "ซิงค์ชื่อ"
4. ตรวจสอบว่าชื่อลูกค้าถูกอัปเดตหรือไม่

### ทดสอบการแสดงชื่อในหน้าออเดอร์
1. ไปที่หน้าออเดอร์ (`/admin/orders`)
2. ตรวจสอบว่าออเดอร์ที่มี userId แสดงชื่อลูกค้าทั้งสองแบบหรือไม่
3. ตรวจสอบว่าชื่อลูกค้าจากระบบแสดงในรูปแบบ badge สีน้ำเงินหรือไม่

### ทดสอบการแก้ไขข้อผิดพลาด 500
1. ไปที่หน้าลูกค้า (`/admin/customers`)
2. ตรวจสอบว่าไม่เกิดข้อผิดพลาด 500 อีกต่อไป
3. ตรวจสอบว่าข้อมูลลูกค้าโหลดได้ปกติ

## หมายเหตุ
- ระบบจะรองรับเบอร์โทรศัพท์ทั้งสองรูปแบบ (0 และ 66) โดยอัตโนมัติ
- การซิงค์ชื่อลูกค้าจะใช้ข้อมูลจากออเดอร์แรกของลูกค้าเท่านั้น
- หากลูกค้าไม่มีออเดอร์ ระบบจะไม่สามารถซิงค์ชื่อได้
- ระบบมีการจัดการข้อผิดพลาดที่ดีขึ้นเพื่อป้องกันข้อผิดพลาด 500
