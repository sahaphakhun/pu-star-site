# ระบบซิงค์ชื่อลูกค้า

## ภาพรวม

ระบบนี้จะทำการซิงค์ชื่อลูกค้าจากข้อมูลออเดอร์เพื่อแก้ปัญหาที่ชื่อลูกค้าแสดงเป็น "ลูกค้า" เสมอ

## การทำงาน

### 1. เมื่อล็อกอินผ่าน Messenger Bot
- ระบบจะสร้างผู้ใช้ใหม่ด้วยชื่อ "ลูกค้า" (ตามค่าเริ่มต้น)
- หลังจากสร้างผู้ใช้สำเร็จ ระบบจะพยายามซิงค์ชื่อจากออเดอร์ที่มีอยู่แล้ว
- สำหรับผู้ใช้เก่า ระบบจะตรวจสอบและซิงค์ชื่อหากจำเป็น

### 2. เมื่อล็อกอินผ่านเว็บไซต์
- ทุกครั้งที่เรียกใช้ `/api/auth/me` ระบบจะตรวจสอบและซิงค์ชื่อหากจำเป็น
- การซิงค์ทำงานแบบ async ไม่รอผลลัพธ์

### 3. เมื่อสร้างออเดอร์ใหม่
- ระบบจะเรียกใช้ `updateUserNameFromOrder` เพื่ออัปเดตชื่อผู้ใช้จากออเดอร์
- ทำงานเฉพาะเมื่อผู้ใช้ยังไม่ได้ตั้งชื่อหรือชื่อเป็น "ลูกค้า"

### 4. การซิงค์ชื่อแบบแมนนวล (ใหม่!)
- แอดมินสามารถซิงค์ชื่อลูกค้าได้แบบแมนนวลผ่านหน้าจัดการลูกค้า
- มีปุ่ม "ซิงค์ชื่อลูกค้าทั้งหมด" เพื่อซิงค์ชื่อลูกค้าทั้งหมดในครั้งเดียว
- มีปุ่ม "ซิงค์ชื่อ" สำหรับแต่ละลูกค้าที่ต้องการซิงค์ชื่อเฉพาะ

## เงื่อนไขการซิงค์ชื่อ

ระบบจะซิงค์ชื่อเมื่อ:
- ผู้ใช้ไม่มีชื่อ (`!user.name`)
- ชื่อเป็น "ลูกค้า" (`user.name === 'ลูกค้า'`)
- ชื่อเป็นเบอร์โทรศัพท์ (`user.name === user.phoneNumber`)
- ชื่อเป็นสตริงว่าง (`user.name.trim() === ''`)

ระบบจะไม่ซิงค์ชื่อเมื่อ:
- ผู้ใช้มีชื่อที่เหมาะสมแล้ว
- ชื่อจากออเดอร์เป็น "ลูกค้า"
- ชื่อจากออเดอร์เป็นเบอร์โทรศัพท์
- ชื่อจากออเดอร์เป็นสตริงว่าง

## ไฟล์ที่เกี่ยวข้อง

- `src/utils/userNameSync.ts` - ฟังก์ชันหลักสำหรับซิงค์ชื่อ
- `src/bot/flows/auth.flow.ts` - ซิงค์ชื่อเมื่อล็อกอินผ่าน Messenger Bot
- `src/app/api/auth/me/route.ts` - ซิงค์ชื่อเมื่อล็อกอินผ่านเว็บไซต์
- `src/app/api/orders/route.ts` - ซิงค์ชื่อเมื่อสร้างออเดอร์
- `src/app/api/admin/customers/route.ts` - API สำหรับการซิงค์ชื่อแบบแมนนวล
- `src/app/(shop)/admin/customers/page.tsx` - หน้าจัดการลูกค้าพร้อมฟีเจอร์ซิงค์ชื่อ

## การใช้งาน

### รันสคริปต์แก้ไขข้อมูลเก่า

```bash
node scripts/fix-customer-names.js
```

สคริปต์นี้จะ:
1. ค้นหาผู้ใช้ทั้งหมดที่ยังไม่ได้ตั้งชื่อหรือชื่อเป็น "ลูกค้า"
2. พยายามซิงค์ชื่อจากออเดอร์แรกของแต่ละคน
3. แสดงผลลัพธ์จำนวนคนที่แก้ไขสำเร็จ

### การซิงค์ชื่อแบบแมนนวล

#### 1. ซิงค์ชื่อลูกค้าทั้งหมด
- ไปที่หน้าจัดการลูกค้า (`/admin/customers`)
- กดปุ่ม "ซิงค์ชื่อลูกค้าทั้งหมด" (สีม่วง)
- ระบบจะซิงค์ชื่อลูกค้าทั้งหมดที่ต้องการ

#### 2. ซิงค์ชื่อลูกค้าเฉพาะคน
- ในตารางลูกค้า จะมีคอลัมน์ "สถานะชื่อ" แสดงสถานะ
- หากสถานะเป็น "ต้องซิงค์ชื่อ" (สีแดง) จะมีปุ่ม "ซิงค์ชื่อ" (สีม่วง)
- กดปุ่มเพื่อซิงค์ชื่อลูกค้าคนนั้น

#### 3. ซิงค์ชื่อจากรายละเอียดลูกค้า
- กดปุ่ม "ดูรายละเอียด" ของลูกค้า
- ในส่วน "สถานะชื่อ" จะมีปุ่ม "คลิกเพื่อซิงค์ชื่อ"
- กดปุ่มเพื่อซิงค์ชื่อลูกค้าคนนั้น

### ตรวจสอบสถานะ

ระบบจะแสดง log ในคอนโซลเมื่อ:
- อัปเดตชื่อผู้ใช้สำเร็จ
- ไม่สามารถซิงค์ชื่อได้
- เกิดข้อผิดพลาดในการซิงค์

## ฟีเจอร์ใหม่ในหน้าจัดการลูกค้า

### 1. ปุ่มซิงค์ชื่อลูกค้าทั้งหมด
- อยู่ด้านขวาบนของหน้า
- สีม่วง พร้อมไอคอน sync
- ต้องมีสิทธิ์ `CUSTOMERS_EDIT`

### 2. คอลัมน์สถานะชื่อ
- แสดงสถานะชื่อของแต่ละลูกค้า
- สีเขียว: "ชื่อถูกต้อง"
- สีแดง: "ต้องซิงค์ชื่อ"

### 3. ปุ่มซิงค์ชื่อเฉพาะคน
- แสดงเฉพาะลูกค้าที่ต้องการซิงค์ชื่อ
- มีทั้งแบบข้อความ (Desktop) และไอคอน (Mobile)
- สีม่วง พร้อม tooltip "ซิงค์ชื่อจากออเดอร์"

### 4. การซิงค์ชื่อในรายละเอียดลูกค้า
- แสดงสถานะชื่อพร้อมปุ่มซิงค์
- ปิด modal หลังจากซิงค์สำเร็จ

## API Endpoints ใหม่

### POST `/api/admin/customers`

#### `action: 'syncCustomerName'`
- `customerId`: ID ของลูกค้าที่ต้องการซิงค์ชื่อ
- Response: ข้อมูลลูกค้าที่อัปเดตแล้ว

#### `action: 'syncAllCustomerNames'`
- ไม่ต้องส่ง parameters เพิ่มเติม
- Response: จำนวนคนที่ซิงค์สำเร็จและทั้งหมด

## หมายเหตุ

- การซิงค์ชื่อทำงานแบบ async เพื่อไม่ให้กระทบประสิทธิภาพการล็อกอิน
- ระบบจะใช้ `setTimeout` เพื่อหน่วงเวลาการซิงค์ 1 วินาที
- หากการซิงค์ล้มเหลว ระบบจะไม่หยุดการทำงานหลัก
- ชื่อที่ซิงค์ได้จะต้องมีความยาว 2-50 ตัวอักษร และไม่ใช่เบอร์โทรศัพท์
- ฟีเจอร์การซิงค์ชื่อแบบแมนนวลต้องมีสิทธิ์ `CUSTOMERS_EDIT` หรือเป็นแอดมิน
