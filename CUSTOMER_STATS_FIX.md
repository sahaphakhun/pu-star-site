# การแก้ไขปัญหาสถิติลูกค้า

## ปัญหาที่พบ
ลูกค้าหลายคนมีการสั่งซื้อแต่ระบบแสดงว่า "ไม่เคยสั่งซื้อ" ในหน้าแอดมิน/ลูกค้า

## สาเหตุของปัญหา
1. ระบบไม่ได้อัปเดตสถิติลูกค้า (`totalOrders`, `totalSpent`, `lastOrderDate`) อัตโนมัติเมื่อมีการเปลี่ยนแปลงออเดอร์
2. ข้อมูลสถิติในฐานข้อมูลไม่ตรงกับข้อมูลออเดอร์จริง
3. ไม่มีระบบการซิงค์ข้อมูลสถิติลูกค้า

## วิธีแก้ไข

### 1. อัปเดตสถิติลูกค้าทั้งหมดผ่านหน้าแอดมิน
- ไปที่หน้าแอดมิน > ลูกค้า
- กดปุ่ม "อัปเดตสถิติลูกค้าทั้งหมด" (สีเขียว)
- รอให้ระบบประมวลผลเสร็จ
- ข้อมูลจะถูกอัปเดตอัตโนมัติ

### 2. อัปเดตสถิติลูกค้าแต่ละคน
- ในตารางลูกค้า แต่ละแถวจะมีปุ่ม "อัปเดตสถิติ" (สีส้ม)
- กดปุ่มนี้เพื่ออัปเดตสถิติของลูกค้าคนนั้นโดยเฉพาะ

### 3. รันสคริปต์อัปเดตสถิติทั้งหมด
```bash
cd scripts
node update-customer-stats.js
```

## ฟีเจอร์ที่เพิ่มเข้ามา

### 1. ฟังก์ชันอัปเดตสถิติอัตโนมัติ
- `updateCustomerStatsAutomatically(userId)` - อัปเดตสถิติลูกค้าคนเดียว
- `updateAllCustomerStats()` - อัปเดตสถิติลูกค้าทั้งหมด

### 2. API Endpoints ใหม่
- `POST /api/admin/customers` with action `updateAllCustomerStats`
- `POST /api/admin/customers` with action `updateCustomerStatsById`

### 3. การอัปเดตอัตโนมัติเมื่อมีการเปลี่ยนแปลงออเดอร์
- เมื่อออเดอร์เปลี่ยนสถานะ ระบบจะอัปเดตสถิติลูกค้าอัตโนมัติ
- สถานะที่ถือว่าเสร็จสิ้น: `delivered`, `confirmed`, `shipped`

## ข้อมูลที่ถูกอัปเดต

### 1. สถิติการสั่งซื้อ
- `totalOrders` - จำนวนออเดอร์ทั้งหมด
- `totalSpent` - ยอดซื้อรวมทั้งหมด
- `averageOrderValue` - ค่าเฉลี่ยต่อออเดอร์
- `lastOrderDate` - วันที่สั่งซื้อล่าสุด

### 2. ประเภทลูกค้า
- `new` - ลูกค้าใหม่ (≤2 ออเดอร์, ≤฿5,000)
- `regular` - ลูกค้าประจำ (>2 ออเดอร์ หรือ >฿5,000)
- `target` - ลูกค้าเป้าหมาย (>฿20,000 หรือสั่งซื้อบ่อย)
- `inactive` - ลูกค้าห่างหาย (>90 วัน)

## การบำรุงรักษา

### 1. รันการอัปเดตสถิติเป็นประจำ
- แนะนำให้รันสคริปต์ `update-customer-stats.js` ทุกสัปดาห์
- หรือใช้ปุ่ม "อัปเดตสถิติลูกค้าทั้งหมด" ในหน้าแอดมิน

### 2. ตรวจสอบข้อมูล
- เปรียบเทียบ `totalOrders` ในตารางลูกค้ากับจำนวนออเดอร์จริง
- ตรวจสอบ `lastOrderDate` ว่าตรงกับออเดอร์ล่าสุดหรือไม่

### 3. การแก้ไขปัญหาเพิ่มเติม
- หากยังมีปัญหา ให้ตรวจสอบ log ใน console
- ตรวจสอบการเชื่อมต่อฐานข้อมูล
- ตรวจสอบสิทธิ์การเข้าถึงฐานข้อมูล

## หมายเหตุ
- การอัปเดตสถิติลูกค้าทั้งหมดอาจใช้เวลานานขึ้นอยู่กับจำนวนลูกค้า
- แนะนำให้รันในช่วงเวลาที่มีผู้ใช้งานน้อย
- ข้อมูลสถิติจะถูกอัปเดตแบบ real-time เมื่อมีการเปลี่ยนแปลงออเดอร์
