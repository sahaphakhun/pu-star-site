# การแก้ไขปัญหาสถิติลูกค้าและการซิงค์ออเดอร์

## ปัญหาที่พบ
1. ลูกค้าหลายคนมีการสั่งซื้อแต่ระบบแสดงว่า "ไม่เคยสั่งซื้อ" ในหน้าแอดมิน/ลูกค้า
2. ออเดอร์ไม่ได้เชื่อมโยงกับผู้ใช้ในระบบ ทำให้สถิติไม่ถูกต้อง
3. ข้อมูลสถิติในฐานข้อมูลไม่ตรงกับข้อมูลออเดอร์จริง

## สาเหตุของปัญหา
1. ระบบไม่ได้อัปเดตสถิติลูกค้า (`totalOrders`, `totalSpent`, `lastOrderDate`) อัตโนมัติเมื่อมีการเปลี่ยนแปลงออเดอร์
2. ออเดอร์เก่าไม่ได้เชื่อมโยงกับ `userId` ทำให้ไม่สามารถคำนวณสถิติได้
3. ไม่มีระบบการซิงค์ข้อมูลสถิติลูกค้าและออเดอร์
4. เบอร์โทรศัพท์ในออเดอร์และผู้ใช้อาจมีรูปแบบต่างกัน (+66 vs 0)

## วิธีแก้ไข

### 1. อัปเดตสถิติลูกค้าทั้งหมดผ่านหน้าแอดมิน
- ไปที่หน้าแอดมิน > ลูกค้า
- กดปุ่ม "อัปเดตสถิติลูกค้าทั้งหมด" (สีเขียว)
- รอให้ระบบประมวลผลเสร็จ
- ข้อมูลจะถูกอัปเดตอัตโนมัติ

### 2. ซิงค์ออเดอร์ทั้งหมด
- กดปุ่ม "ซิงค์ออเดอร์ทั้งหมด" (สีน้ำเงิน)
- ระบบจะเชื่อมโยงออเดอร์ที่มีเบอร์ตรงกันกับผู้ใช้
- รองรับเบอร์สองรูปแบบ: +66xxxxxxxxx และ 0xxxxxxxxx
- ป้องกันออเดอร์ซ้ำโดยใช้ unique key

### 3. อัปเดตสถิติลูกค้าแต่ละคน
- ในตารางลูกค้า แต่ละแถวจะมีปุ่ม "อัปเดตสถิติ" (สีส้ม)
- กดปุ่มนี้เพื่ออัปเดตสถิติของลูกค้าคนนั้นโดยเฉพาะ

### 4. ซิงค์ออเดอร์แต่ละคน
- ในตารางลูกค้า แต่ละแถวจะมีปุ่ม "ซิงค์ออเดอร์" (สีน้ำเงินเข้ม)
- กดปุ่มนี้เพื่อซิงค์ออเดอร์ของลูกค้าคนนั้นโดยเฉพาะ

### 5. รันสคริปต์อัปเดตสถิติทั้งหมด
```bash
cd scripts
node update-customer-stats.js
```

### 6. รันสคริปต์ซิงค์ออเดอร์ทั้งหมด
```bash
cd scripts
node sync-orders-to-users.js
```

## ฟีเจอร์ที่เพิ่มเข้ามา

### 1. ฟังก์ชันอัปเดตสถิติอัตโนมัติ
- `updateCustomerStatsAutomatically(userId)` - อัปเดตสถิติลูกค้าคนเดียว
- `updateAllCustomerStats()` - อัปเดตสถิติลูกค้าทั้งหมด

### 2. ฟังก์ชันซิงค์ออเดอร์
- `syncOrdersToUser(userId, userPhoneNumber)` - ซิงค์ออเดอร์ให้ลูกค้าคนเดียว
- `syncAllOrdersToUsers()` - ซิงค์ออเดอร์ทั้งหมดในระบบ

### 3. API Endpoints ใหม่
- `POST /api/admin/customers` with action `updateAllCustomerStats`
- `POST /api/admin/customers` with action `updateCustomerStatsById`
- `POST /api/admin/customers` with action `syncOrdersToUser`
- `POST /api/admin/customers` with action `syncAllOrdersToUsers`

### 4. การอัปเดตอัตโนมัติเมื่อมีการเปลี่ยนแปลงออเดอร์
- เมื่อออเดอร์เปลี่ยนสถานะ ระบบจะอัปเดตสถิติลูกค้าอัตโนมัติ
- สถานะที่ถือว่าเสร็จสิ้น: `delivered`, `confirmed`, `shipped`

## ข้อมูลที่ถูกอัปเดต

### 1. สถิติการสั่งซื้อ
- `totalOrders` - จำนวนออเดอร์ทั้งหมด
- `totalSpent` - ยอดซื้อรวมทั้งหมด
- `averageOrderValue` - ค่าเฉลี่ยต่อออเดอร์
- `lastOrderDate` - วันที่สั่งซื้อล่าสุด

### 2. ประเภทลูกค้า
- `new` - ลูกค้าใหม่ (≤2 ออเดอร์, ≤฿5,000)
- `regular` - ลูกค้าประจำ (>2 ออเดอร์ หรือ >฿5,000)
- `target` - ลูกค้าเป้าหมาย (>฿20,000 หรือสั่งซื้อบ่อย)
- `inactive` - ลูกค้าห่างหาย (>90 วัน)

### 3. การเชื่อมโยงออเดอร์
- `userId` - เชื่อมโยงออเดอร์กับผู้ใช้ในระบบ
- รองรับเบอร์โทรสองรูปแบบ: +66xxxxxxxxx และ 0xxxxxxxxx
- ป้องกันออเดอร์ซ้ำโดยใช้ unique key

## การป้องกันออเดอร์ซ้ำ

### 1. Unique Key Generation
```javascript
const orderKey = `${order.customerPhone}_${order.totalAmount}_${orderDate}`;
```

### 2. การตรวจสอบซ้ำ
- ใช้ Set เพื่อเก็บ orderKey ที่ซิงค์แล้ว
- ข้ามออเดอร์ที่มี key ซ้ำ
- แสดงจำนวนออเดอร์ที่ข้ามไป

### 3. รูปแบบเบอร์โทรที่รองรับ
- +66xxxxxxxxx → 0xxxxxxxxx
- 0xxxxxxxxx → +66xxxxxxxxx
- 66xxxxxxxxx → +66xxxxxxxxx, 0xxxxxxxxx

## การบำรุงรักษา

### 1. รันการอัปเดตสถิติเป็นประจำ
- แนะนำให้รันสคริปต์ `update-customer-stats.js` ทุกสัปดาห์
- หรือใช้ปุ่ม "อัปเดตสถิติลูกค้าทั้งหมด" ในหน้าแอดมิน

### 2. รันการซิงค์ออเดอร์เป็นประจำ
- แนะนำให้รันสคริปต์ `sync-orders-to-users.js` ทุกสัปดาห์
- หรือใช้ปุ่ม "ซิงค์ออเดอร์ทั้งหมด" ในหน้าแอดมิน

### 3. ตรวจสอบข้อมูล
- เปรียบเทียบ `totalOrders` ในตารางลูกค้ากับจำนวนออเดอร์จริง
- ตรวจสอบ `lastOrderDate` ว่าตรงกับออเดอร์ล่าสุดหรือไม่
- ตรวจสอบการเชื่อมโยง `userId` ในออเดอร์

### 4. การแก้ไขปัญหาเพิ่มเติม
- หากยังมีปัญหา ให้ตรวจสอบ log ใน console
- ตรวจสอบการเชื่อมต่อฐานข้อมูล
- ตรวจสอบสิทธิ์การเข้าถึงฐานข้อมูล

## หมายเหตุ
- การอัปเดตสถิติลูกค้าทั้งหมดอาจใช้เวลานานขึ้นอยู่กับจำนวนลูกค้า
- การซิงค์ออเดอร์ทั้งหมดอาจใช้เวลานานขึ้นอยู่กับจำนวนออเดอร์
- แนะนำให้รันในช่วงเวลาที่มีผู้ใช้งานน้อย
- ข้อมูลสถิติจะถูกอัปเดตแบบ real-time เมื่อมีการเปลี่ยนแปลงออเดอร์
- ระบบจะป้องกันออเดอร์ซ้ำโดยอัตโนมัติ
