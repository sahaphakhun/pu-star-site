# ระบบเชื่อมโยงออเดอร์และผู้ใช้ (Order-User Mapping System)

## ภาพรวม

ระบบเชื่อมโยงออเดอร์และผู้ใช้ถูกพัฒนาขึ้นเพื่อจัดการความสัมพันธ์ระหว่างออเดอร์กับผู้ใช้ในระบบให้สามารถติดตามและจัดการได้อย่างมีประสิทธิภาพ

## ฟีเจอร์หลัก

### 1. ระบบแสดงผลข้อมูล
- **ดูออเดอร์จากผู้ใช้**: สามารถคลิกดูได้ว่าออเดอร์นั้น ๆ เป็นของลูกค้าคนใด
- **ดูประวัติออเดอร์**: สามารถดูได้ว่าลูกค้าคนหนึ่ง ๆ เคยสั่งอะไรบ้าง มีออเดอร์อะไรทั้งหมด
- **ข้อมูลแบบ Two-way mapping**: ดูได้ทั้งจาก Order → User และ User → Orders

### 2. ระบบ Auto Mapping (ระบบหลัก)
- **การเชื่อมโยงอัตโนมัติ**: เมื่อมีการสั่งซื้อใหม่ ระบบจะทำการ map ออเดอร์กับผู้ใช้โดยอัตโนมัติ
- **ตรวจจับข้อมูล**: ใช้ข้อมูลเบอร์โทรศัพท์ในการจับคู่

### 3. ระบบ Manual Mapping
- **หน้าจัดการออเดอร์**: ในหน้าออเดอร์ มีปุ่ม "จัดการ"
- **เลือกลูกค้า**: เมื่อคลิกจัดการ สามารถเลือกลูกค้าได้จาก:
  - รายการลูกค้าทั้งหมด (dropdown/list)
  - ค้นหาจากเบอร์โทรศัพท์
  - ค้นหาจากชื่อ
- **การแก้ไข**: สามารถเปลี่ยนแปลงการเชื่อมโยงได้ภายหลัง

### 4. ระบบซิงค์ข้อมูลเก่า
- **รองรับข้อมูลเดิม**: ระบบสามารถทำงานกับข้อมูลออเดอร์และผู้ใช้ที่มีอยู่แล้ว
- **ปุ่มซิงค์ข้อมูล**: มีปุ่มสำหรับซิงค์ข้อมูลเก่าให้เชื่อมโยงกัน
- **การประมวลผลแบบ Batch**: สามารถประมวลผลข้อมูลเก่าทั้งหมดพร้อมกันได้

## โครงสร้างฐานข้อมูล

### การเปลี่ยนแปลงใน Order Model
```typescript
// เพิ่มฟิลด์ userId ในตาราง orders
userId: {
  type: Schema.Types.ObjectId,
  ref: 'User',
  index: true,
}
```

### การเปลี่ยนแปลงใน User Model
```typescript
// เพิ่มฟิลด์สำหรับติดตามสถิติ
lastOrderDate: Date;
totalOrders: number;
totalSpent: number;
averageOrderValue: number;
```

## API Endpoints

### 1. `/api/orders/mapping`
- **GET**: ดึงสถิติการ mapping และรายการออเดอร์ที่ยังไม่ได้ mapping
- **POST**: ทำการ auto mapping, manual mapping, หรือ batch sync

### 2. `/api/users/search`
- **GET**: ค้นหาผู้ใช้สำหรับการ manual mapping

### 3. `/api/users/[id]/orders`
- **GET**: ดึงออเดอร์ของผู้ใช้ตาม userId

## คอมโพเนนต์ที่สร้างขึ้น

### 1. OrderMappingManager
- จัดการการเชื่อมโยงออเดอร์กับผู้ใช้
- แสดงสถิติการ mapping
- ระบบ auto mapping และ batch sync
- Modal สำหรับ manual mapping

### 2. UserOrderHistory
- แสดงประวัติออเดอร์ของผู้ใช้
- ระบบ pagination และ filtering
- แสดงสถิติการซื้อของผู้ใช้

## หน้าจอที่เพิ่มขึ้น

### 1. `/admin/orders/mapping`
- หน้าเฉพาะสำหรับจัดการการเชื่อมโยงออเดอร์
- แสดงสถิติและรายการออเดอร์ที่ยังไม่ได้ mapping

### 2. การอัปเดตใน `/admin/orders`
- เพิ่มปุ่ม "จัดการการเชื่อมโยง" ในหน้าออเดอร์
- แสดงข้อมูลผู้ใช้ในตารางออเดอร์
- ปุ่ม "ดูประวัติ" สำหรับออเดอร์ที่มีการเชื่อมโยงแล้ว

## การทำงานของระบบ

### Workflow หลัก
1. **ออเดอร์ใหม่เข้ามา** → ระบบพยายาม auto-map กับผู้ใช้ที่มี
2. **หาก auto-map ไม่ได้** → แสดงเป็น "ไม่ระบุลูกค้า" พร้อมปุ่มจัดการ
3. **Admin คลิกจัดการ** → เปิด modal เลือกลูกค้า
4. **เลือกลูกค้า** → บันทึกการเชื่อมโยงลงฐานข้อมูล

### การซิงค์ข้อมูลเก่า
1. **คลิกปุ่มซิงค์** → ระบบเริ่มประมวลผลข้อมูลเก่า
2. **จับคู่ข้อมูล** → ใช้เบอร์โทรในการจับคู่
3. **แสดงผลลัพธ์** → รายงานจำนวนที่ซิงค์สำเร็จ/ไม่สำเร็จ
4. **Manual review** → รายการที่ซิงค์ไม่ได้ให้ admin จัดการเอง

## การใช้งาน

### สำหรับ Admin
1. เข้าไปที่ `/admin/orders/mapping` เพื่อจัดการการเชื่อมโยง
2. ใช้ปุ่ม "Auto Mapping" เพื่อเชื่อมโยงอัตโนมัติ
3. ใช้ปุ่ม "Batch Sync" เพื่อซิงค์ข้อมูลเก่า
4. คลิก "จัดการ" ในรายการออเดอร์เพื่อ manual mapping

### การดูประวัติลูกค้า
1. ในหน้าออเดอร์ คลิก "ดูประวัติ" ตรงชื่อลูกค้า
2. ระบบจะแสดงประวัติออเดอร์ทั้งหมดของลูกค้านั้น
3. สามารถกรองตามสถานะและดูสถิติได้

## ประโยชน์ที่ได้รับ

1. **การติดตามลูกค้า**: สามารถติดตามพฤติกรรมการซื้อของลูกค้าได้
2. **การวิเคราะห์ข้อมูล**: มีข้อมูลสถิติสำหรับการวิเคราะห์
3. **การจัดการลูกค้า**: สามารถจัดการลูกค้าได้อย่างมีประสิทธิภาพ
4. **การรายงาน**: สามารถสร้างรายงานเกี่ยวกับลูกค้าและออเดอร์ได้

## การบำรุงรักษา

### การอัปเดตสถิติ
- ระบบจะอัปเดตสถิติของผู้ใช้อัตโนมัติเมื่อมีการเชื่อมโยงใหม่
- สามารถรัน batch sync เพื่ออัปเดตสถิติทั้งหมดได้

### การตรวจสอบข้อมูล
- ตรวจสอบอัตราการ mapping ผ่านสถิติในหน้า mapping
- ตรวจสอบออเดอร์ที่ยังไม่ได้ mapping ในรายการ

## ข้อควรระวัง

1. **การซิงค์ข้อมูลเก่า**: ควรทำในช่วงเวลาที่มีผู้ใช้งานน้อย
2. **การ manual mapping**: ควรตรวจสอบข้อมูลให้ถูกต้องก่อนบันทึก
3. **การลบข้อมูล**: ควรระวังในการลบการเชื่อมโยงที่มีอยู่แล้ว

## การพัฒนาต่อ

1. **การเพิ่มฟิลด์ mapping**: เพิ่มการ mapping ตามอีเมลหรือข้อมูลอื่นๆ
2. **การแจ้งเตือน**: แจ้งเตือนเมื่อมีออเดอร์ใหม่ที่ยังไม่ได้ mapping
3. **การรายงาน**: สร้างรายงานสถิติการ mapping
4. **การ export**: ส่งออกข้อมูลการ mapping เป็นไฟล์ Excel
