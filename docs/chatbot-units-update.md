# ЁЯдЦ р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З Chatbot Flow р╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕░р╕Ър╕Ър╕лр╕Щр╣Ир╕зр╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓

## р╕кр╕гр╕╕р╕Ыр╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕З

### 1. ЁЯФД Flow р╕Бр╕▓р╕гр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕нр╣Гр╕лр╕бр╣И

**Flow р╣Ар╕Фр╕┤р╕б:**
```
р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ тЖТ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б (р╕Цр╣Йр╕▓р╕бр╕╡) тЖТ р╕Ир╕│р╕Щр╕зр╕Щ тЖТ р╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕Зр╕Хр╕░р╕Бр╕гр╣Йр╕▓
```

**Flow р╣Гр╕лр╕бр╣И:**
```
р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ тЖТ р╕лр╕Щр╣Ир╕зр╕в (р╕Цр╣Йр╕▓р╕бр╕╡) тЖТ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б (р╕Цр╣Йр╕▓р╕бр╕╡) тЖТ р╕Ир╕│р╕Щр╕зр╕Щ тЖТ р╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕Зр╕Хр╕░р╕Бр╕гр╣Йр╕▓
```

### 2. ЁЯУЭ р╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Вр╕Др╣Йр╕Ф

#### A. State Management (`src/bot/state.ts`)
- р╣Ар╕Юр╕┤р╣Ир╕б `unitLabel` р╣Бр╕ер╕░ `unitPrice` р╣Гр╕Щ `CartItem` interface
- р╕Ыр╕гр╕▒р╕Ъ `addToCart()` р╣Гр╕лр╣Йр╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕Чр╕╡р╕вр╕Ъ item р╕Хр╕▓р╕б productId + unitLabel + selectedOptions

#### B. Product Flow (`src/bot/flows/product.flow.ts`)
- р╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ `askUnit()` р╣Бр╕ер╕░ `handleUnitPostback()`
- р╕Ыр╕гр╕▒р╕Ъ `handleOrderPostback()` р╣Гр╕лр╣Йр╕Цр╕▓р╕бр╕лр╕Щр╣Ир╕зр╕вр╕Бр╣Ир╕нр╕Щр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б
- р╕Ыр╕гр╕▒р╕Ъ `addProductWithOptions()` р╣Гр╕лр╣Йр╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕Щр╣Ир╕зр╕вр╣Гр╕Щ cart
- р╕Ыр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╣Гр╕лр╣Йр╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Ир╕зр╕вр╣Бр╕ер╕░р╕Ир╕│р╕Щр╕зр╕Щ

#### C. Order Flow (`src/bot/flows/order.flow.ts`)
- р╕Ыр╕гр╕▒р╕Ъ `handleAddress()` р╣Гр╕лр╣Йр╣Бр╕кр╕Фр╕Зр╕лр╕Щр╣Ир╕зр╕вр╣Бр╕ер╕░р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Бр╣Гр╕Щр╕кр╕гр╕╕р╕Ыр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М
- р╕Ыр╕гр╕▒р╕Ъ `finalizeOrder()` р╣Гр╕лр╣Йр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕Щр╣Ир╕зр╕вр╣Др╕Ыр╣Гр╕Щ API

#### D. Order Model (`src/models/Order.ts`)
- р╣Ар╕Юр╕┤р╣Ир╕б `unitLabel` р╣Бр╕ер╕░ `unitPrice` р╣Гр╕Щ `IOrderItem` interface р╣Бр╕ер╕░ schema

### 3. ЁЯЫая╕П Migration Script

р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М `scripts/migrate-products-add-units.js` р╕кр╕│р╕лр╕гр╕▒р╕Ъ:
- р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╣Ир╕зр╕вр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ "р╕лр╕Щр╣Ир╕зр╕в" р╣Гр╕лр╣Йр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕лр╕Щр╣Ир╕зр╕в
- р╣Гр╕Кр╣Йр╕гр╕▓р╕Др╕▓р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щр╕Вр╕нр╕Зр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╕гр╕▓р╕Др╕▓р╕лр╕Щр╣Ир╕зр╕в
- р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З: `npm run migrate:units`

### 4. ЁЯОп UX р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З

#### р╕Бр╕▓р╕гр╕Цр╕▓р╕бр╕лр╕Щр╣Ир╕зр╕в
```
Bot: р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕Щр╣Ир╕зр╕вр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕кр╕│р╕лр╕гр╕▒р╕Ъ р╕Щр╣Йр╕│р╕вр╕▓р╕ер╣Йр╕▓р╕Зр╕лр╣Йр╕нр╕Зр╕Щр╣Йр╕│
Quick Replies:
- р╕лр╕ер╕нр╕Ф (99р╕┐)
- р╕ер╕▒р╕З (1,200р╕┐)
```

#### р╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓
```
Bot: р╣Ар╕Юр╕┤р╣Ир╕б р╕Щр╣Йр╕│р╕вр╕▓р╕ер╣Йр╕▓р╕Зр╕лр╣Йр╕нр╕Зр╕Щр╣Йр╕│ (р╕ер╕▒р╕З) р╕Ир╕│р╕Щр╕зр╕Щ 2 р╣Гр╕Щр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╣Бр╕ер╣Йр╕з ЁЯОЙ
р╕вр╕нр╕Фр╕гр╕зр╕бр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕з: 2,400 р╕Ър╕▓р╕Ч
```

#### р╕Бр╕▓р╕гр╕кр╕гр╕╕р╕Ыр╕нр╕нр╣Ар╕Фр╕нр╕гр╣М
```
р╕кр╕гр╕╕р╕Ыр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н
тАв р╕Щр╣Йр╕│р╕вр╕▓р╕ер╣Йр╕▓р╕Зр╕лр╣Йр╕нр╕Зр╕Щр╣Йр╕│ x2 (р╕ер╕▒р╕З) [р╕кр╕╡: р╣Бр╕Фр╕З, р╕Вр╕Щр╕▓р╕Ф: L]
тАв р╕кр╕Ър╕╣р╣Ир╣Ар╕лр╕ер╕з x1 (р╕лр╕ер╕нр╕Ф)
р╕вр╕нр╕Фр╕гр╕зр╕б 2,499 р╕Ър╕▓р╕Ч
р╕Кр╕╖р╣Ир╕н: р╕Др╕╕р╕Ур╕ер╕╣р╕Бр╕Др╣Йр╕▓
р╕Чр╕╡р╣Ир╕нр╕вр╕╣р╣И: 123 р╕Цр╕Щр╕Щр╕кр╕╕р╕Вр╕╕р╕бр╕зр╕┤р╕Ч...
```

### 5. ЁЯФН р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

1. **р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕лр╕Щр╣Ир╕зр╕вр╣Ар╕Фр╕╡р╕вр╕з:** р╕Др╕зр╕гр╕Вр╣Йр╕▓р╕бр╕Бр╕▓р╕гр╕Цр╕▓р╕бр╕лр╕Щр╣Ир╕зр╕в
2. **р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕лр╕ер╕▓р╕вр╕лр╕Щр╣Ир╕зр╕в:** р╕Др╕зр╕гр╕Цр╕▓р╕бр╕лр╕Щр╣Ир╕зр╕вр╕Бр╣Ир╕нр╕Щр╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б
3. **р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕бр╕╡р╕Чр╕▒р╣Йр╕Зр╕лр╕Щр╣Ир╕зр╕вр╣Бр╕ер╕░р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б:** flow р╕Др╕гр╕Ъ р╕лр╕Щр╣Ир╕зр╕в тЖТ р╕Хр╕▒р╕зр╣Ар╕ер╕╖р╕нр╕Б тЖТ р╕Ир╕│р╕Щр╕зр╕Щ
4. **р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╕ер╕Зр╕Хр╕░р╕Бр╕гр╣Йр╕▓:** р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Ар╕Фр╕╡р╕вр╕зр╕Бр╕▒р╕Щр╕лр╕Щр╣Ир╕зр╕вр╕Хр╣Ир╕▓р╕Зр╕Бр╕▒р╕Щр╕Др╕зр╕гр╣Бр╕вр╕Бр╕гр╕▓р╕вр╕Бр╕▓р╕г
5. **р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╕▒р╣Ир╕Зр╕Лр╕╖р╣Йр╕н:** р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕Щр╣Ир╕зр╕вр╕Др╕зр╕гр╕Цр╕╣р╕Бр╕кр╣Ир╕Зр╣Др╕Ыр╣Гр╕Щ order

### 6. ЁЯУК р╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣Мр╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ъ

- тЬЕ р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕Щр╣Ир╕зр╕вр╣Др╕Фр╣Йр╕Хр╕▓р╕бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г
- тЬЕ р╕гр╕▓р╕Др╕▓р╣Бр╕кр╕Фр╕Зр╕Хр╕▓р╕бр╕лр╕Щр╣Ир╕зр╕вр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╣Бр╕Ър╕Ъ real-time
- тЬЕ р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г inventory р╕Чр╕│р╣Др╕Фр╣Йр╕Зр╣Ир╕▓р╕вр╕Вр╕╢р╣Йр╕Щ
- тЬЕ Admin р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╣Ир╕зр╕вр╣Гр╕лр╕бр╣Ир╣Др╕Фр╣Йр╣Вр╕Фр╕вр╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Вр╕Др╣Йр╕Ф
- тЬЕ р╕Вр╣Йр╕нр╕бр╕╣р╕е order р╣Ар╕Бр╣Зр╕Ър╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╕лр╕Щр╣Ир╕зр╕вр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

### 7. ЁЯЪА р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Цр╕▒р╕Фр╣Др╕Ы

1. р╕гр╕▒р╕Щ migration: `npm run migrate:units`
2. р╕Чр╕Фр╕кр╕нр╕Ъ chatbot flow р╣Гр╕Щ development
3. р╕Чр╕Фр╕кр╕нр╕Ър╣Гр╕Щ production environment
4. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╣Гр╕Щ admin panel 