#!/usr/bin/env node

/**
 * р╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ LINE
 * р╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╣Ир╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Др╕Ыр╕вр╕▒р╕Зр╕Бр╕ер╕╕р╣Ир╕бр╣Др╕ер╕Щр╣М
 */

require('dotenv').config();
const { notifyAllLineGroups } = require('../src/utils/line');

async function testLineNotification() {
  console.log('ЁЯЪА р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ LINE...\n');
  
  try {
    // р╕Чр╕Фр╕кр╕нр╕Ър╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ
    const testMessage = `ЁЯзк р╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ: р╕Бр╕▓р╕гр╕кр╣Ир╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ LINE\n\nр╣Ар╕зр╕ер╕▓: ${new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })}\n\nр╕Щр╕╡р╣Ир╕Др╕╖р╕нр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕Юр╕╖р╣Ир╕нр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕гр╕░р╕Ър╕Ър╕Чр╕│р╕Зр╕▓р╕Щр╕Ыр╕Бр╕Хр╕┤`;
    
    console.log('ЁЯУЭ р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Чр╕Фр╕кр╕нр╕Ъ:');
    console.log(testMessage);
    console.log('\nЁЯУд р╕Бр╕│р╕ер╕▒р╕Зр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б...');
    
    const result = await notifyAllLineGroups(testMessage);
    
    if (result) {
      console.log('\nтЬЕ р╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ:');
      console.log(`- р╕Ир╕│р╕Щр╕зр╕Щр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: ${result.total}`);
      console.log(`- р╕кр╣Ир╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И: ${result.successful}`);
      console.log(`- р╕кр╣Ир╕Зр╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И: ${result.failed}`);
      
      if (result.successful > 0) {
        console.log('\nЁЯОЙ р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И! р╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ LINE р╕Чр╕│р╕Зр╕▓р╕Щр╕Ыр╕Бр╕Хр╕┤');
      } else {
        console.log('\nтЪая╕П  р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕ер╕╕р╣Ир╕бр╣Др╕ер╕Щр╣Мр╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓');
      }
    } else {
      console.log('\nтЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╣Ир╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Др╕Фр╣Й');
    }
    
  } catch (error) {
    console.error('\nЁЯТе р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ:', error.message);
    
    if (error.message.includes('LINE_CHANNEL_ACCESS_TOKEN')) {
      console.log('\nЁЯТб р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓:');
      console.log('1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ LINE_CHANNEL_ACCESS_TOKEN р╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕Щ .env');
      console.log('2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Token р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕░р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕');
    }
    
    if (error.message.includes('MongoDB')) {
      console.log('\nЁЯТб р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓:');
      console.log('1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н MongoDB');
      console.log('2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ MONGODB_URI р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З');
    }
  }
}

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ
function checkEnvironmentVariables() {
  const required = [
    'LINE_CHANNEL_ACCESS_TOKEN',
    'LINE_CHANNEL_SECRET',
    'MONGODB_URI'
  ];
  
  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('тЭМ р╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕лр╕▓р╕вр╣Др╕Ы:');
    missing.forEach(key => console.error(`   - ${key}`));
    console.log('\nЁЯТб р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕Щр╣Др╕Яр╕ер╣М .env р╕Хр╕▓р╕б env.example');
    process.exit(1);
  }
  
  console.log('тЬЕ р╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ\n');
}

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Б
async function main() {
  console.log('ЁЯФз р╕гр╕░р╕Ър╕Ър╕Чр╕Фр╕кр╕нр╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ LINE р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Кр╕Чр╣Ар╕Яр╕Лр╕Ър╕╕р╣Кр╕Д\n');
  
  // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕б
  checkEnvironmentVariables();
  
  // р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕Фр╕кр╕нр╕Ъ
  await testLineNotification();
  
  console.log('\nЁЯПБ р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ');
}

// р╣Ар╕гр╕╡р╕вр╕Бр╣Гр╕Кр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Б
if (require.main === module) {
  main().catch(console.error);
}

module.exports = { testLineNotification };
