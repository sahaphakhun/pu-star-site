# การแก้ไขปัญหาระบบ AI ที่ไม่ทำงานเมื่อลูกค้าส่งข้อความซ้ำๆ

## ปัญหาที่พบ
จากล็อกที่แสดงให้เห็น ระบบมีการตอบกลับซ้ำๆ แทนที่จะเปิดโหมด AI หรือจัดการข้อความที่ไม่ใช่เมนูอย่างเหมาะสม:

```
[Flow] handleEvent for 8993105170800679 {"sender":{"id":"8993105170800679"},"recipient":{"id":"338193849376829"},"timestamp":1755057751760,"message":{"mid":"m_jjeOmCJTZrb_xjB5Go0RjdDvw8rXKPAXBMOseTbOCqNj8C7kRelevlVXwiTaC2d-tfY1m2_hGE3fiGwidPyJ6g","text":"เมนูหลัก","quick_reply":{"payload":"SHOW_MENU"}}}

[Flow] handleEvent for 8993105170800679 {"sender":{"id":"8993105170800679"},"recipient":{"id":"338193849376829"},"timestamp":1755057760227,"message":{"mid":"m_g8j0f4xmYNtjQ2qUY0wgANDvw8rXKPAXBMOseTbOCqMaDpYKb26VDLNyLOGzJ5wsljMjraaPKcgmXveIoSJO3g","text":"สวัสดี"}}
```

## สาเหตุของปัญหา

### 1. **ข้อความ "สวัสดี" ถูกจัดการหลังจาก AI mode แล้ว**
- ระบบส่ง `sendWelcome()` ซ้ำๆ แทนที่จะใช้ AI ตอบคำถาม

### 2. **ผู้ใช้ใหม่ไม่ได้เปิดโหมด AI**
- ระบบไม่สามารถตอบคำถามได้เพราะไม่ได้เปิดโหมด AI

### 3. **การนับข้อความที่ไม่ใช่เมนูไม่ทำงาน**
- ระบบส่งข้อความเริ่มต้นแทนที่จะนับและเปิดโหมดอัตโนมัติ

## การแก้ไขที่ทำ

### 1. **เปิดโหมด AI ให้ผู้ใช้ใหม่โดยอัตโนมัติ**
```typescript
// เปิดโหมด AI ให้ผู้ใช้ใหม่โดยอัตโนมัติ
if (!aiEnabled) {
  console.log(`[AI Debug] Enabling AI for new user: ${psid}`);
  await enableAIForUser(psid);
}
```

### 2. **ปรับลำดับการจัดการข้อความ**
- ย้ายการจัดการข้อความ "สวัสดี" ให้อยู่ในเงื่อนไขที่ถูกต้อง
- ตรวจสอบโหมด AI ก่อนส่งข้อความเริ่มต้น

### 3. **ปรับปรุงการจัดการ fallback**
```typescript
// ถ้าไม่เข้าเงื่อนไขใด และไม่ได้อยู่ในโหมด AI ให้ส่งเมนูเริ่มต้น
const currentAiEnabled = await isAIEnabled(psid);
if (!currentAiEnabled) {
  if (session.step === 'browse') {
    return sendWelcome(psid);
  }
  return showCategories(psid);
}

// ถ้าอยู่ในโหมด AI แต่ไม่ได้ส่งข้อความใดๆ ให้ส่งข้อความแนะนำ
if (currentAiEnabled && event.message && event.message.text) {
  await callSendAPI(psid, {
    text: 'กรุณาพิมพ์คำถามหรือความต้องการของคุณได้เลยค่ะ',
    quick_replies: [
      { content_type: 'text', title: 'เมนูหลัก', payload: 'SHOW_MENU' },
      { content_type: 'text', title: 'ดูสินค้า', payload: 'SHOW_PRODUCTS' },
    ],
  });
  return;
}
```

## ผลลัพธ์ที่คาดหวัง

### 1. **ผู้ใช้ใหม่จะได้รับโหมด AI โดยอัตโนมัติ**
- ไม่ต้องกดเมนูเพื่อเปิดโหมด AI

### 2. **ระบบจะตอบคำถามแทนการส่งเมนูซ้ำ**
- เมื่อลูกค้าพิมพ์ "สวัสดี" หรือข้อความอื่นๆ ระบบจะใช้ AI ตอบคำถาม

### 3. **การนับข้อความที่ไม่ใช่เมนูจะทำงานได้**
- หลังจาก 2 ครั้ง ระบบจะเปิดโหมดอัตโนมัติ

### 4. **ลดการตอบกลับซ้ำ**
- ระบบจะไม่ส่งเมนูเริ่มต้นซ้ำๆ เมื่อลูกค้าอยู่ในโหมด AI

## การทดสอบ

### 1. **ทดสอบผู้ใช้ใหม่**
- ส่งข้อความ "สวัสดี" → ระบบควรเปิดโหมด AI และตอบคำถาม

### 2. **ทดสอบการส่งข้อความซ้ำ**
- ส่งข้อความที่ไม่ใช่เมนู 2 ครั้ง → ระบบควรเปิดโหมดอัตโนมัติ

### 3. **ทดสอบการกลับเมนู**
- กดปุ่ม "เมนูหลัก" → ระบบควรปิดโหมด AI และแสดงเมนูปกติ

## หมายเหตุ
การแก้ไขนี้จะทำให้ระบบ AI ทำงานได้อย่างถูกต้องและลดปัญหาการตอบกลับซ้ำๆ ที่ลูกค้าเคยพบ
