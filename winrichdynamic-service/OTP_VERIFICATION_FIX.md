# ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ OTP Verification ‡πÉ‡∏ô B2B Service

## üêõ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö

```
POST https://www.b2b.winrichdynamic.com/api/adminb2b/register/verify-otp 500 (Internal Server Error)
```

## üîç ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤

1. **‡πÉ‡∏ä‡πâ Global Cache ‡πÅ‡∏ó‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**: B2B Service ‡πÉ‡∏ä‡πâ global cache (`global.registerOtpCache`) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
2. **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**: ‡πÉ‡∏ä‡πâ `result.result.ref` ‡πÄ‡∏õ‡πá‡∏ô OTP ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verify
3. **‡πÑ‡∏°‡πà‡∏°‡∏µ OTPVerification Model**: B2B ‡πÑ‡∏°‡πà‡∏°‡∏µ model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OTP ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
4. **‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏´‡∏•‡∏±‡∏Å**: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ

## ‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏≥

### 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á OTPVerification Model

**‡πÑ‡∏ü‡∏•‡πå:** `src/models/OTPVerification.ts`

```typescript
import mongoose, { Schema, Document } from 'mongoose';

export interface IOTPVerification extends Document {
  phoneNumber: string;
  token: string;      // token ‡∏à‡∏≤‡∏Å DeeSMSx
  ref: string;        // ref ‡∏à‡∏≤‡∏Å DeeSMSx
  requestNo: string;  // requestNo ‡∏à‡∏≤‡∏Å DeeSMSx
  createdAt: Date;
  expiresAt: Date;
}

const OTPVerificationSchema: Schema = new Schema({
  phoneNumber: {
    type: String,
    required: true,
    trim: true,
    match: [/^\+?66\d{9}$/, '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'],
  },
  token: { type: String, required: true },
  ref: { type: String, required: true },
  requestNo: { type: String, required: true },
  createdAt: { type: Date, default: Date.now },
  expiresAt: { type: Date, required: true },
});

// Indexes ‡πÅ‡∏•‡∏∞ TTL
OTPVerificationSchema.index({ phoneNumber: 1 });
OTPVerificationSchema.index({ expiresAt: 1 }, { expireAfterSeconds: 0 });

export default mongoose.models.OTPVerification || mongoose.model<IOTPVerification>('OTPVerification', OTPVerificationSchema);
```

### 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå Send OTP

**‡πÑ‡∏ü‡∏•‡πå:** `src/app/api/adminb2b/register/send-otp/route.ts`

**‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å:**
- ‡πÉ‡∏ä‡πâ global cache
- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô memory

**‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:**
- ‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OTPVerification
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
- ‡πÄ‡∏Å‡πá‡∏ö token, ref, requestNo ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå Verify OTP

**‡πÑ‡∏ü‡∏•‡πå:** `src/app/api/adminb2b/register/verify-otp/route.ts`

**‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å:**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP ‡∏à‡∏≤‡∏Å global cache
- ‡πÉ‡∏ä‡πâ ref ‡πÄ‡∏õ‡πá‡∏ô OTP

**‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:**
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- ‡πÉ‡∏ä‡πâ token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verifyOTP
- ‡∏•‡∏ö OTP record ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å verify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

## üîÑ ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà

### 1. ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á OTP
```
1. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡πà‡∏á OTP
2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö OTP ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
4. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á DeeSMSx API
5. ‡πÄ‡∏Å‡πá‡∏ö token, ref, requestNo ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
6. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö
```

### 2. ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
```
1. ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ OTP record ‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ OTP ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
5. ‡πÉ‡∏ä‡πâ verifyOTP(token, otp) ‡∏Å‡∏±‡∏ö DeeSMSx
6. ‡∏™‡∏£‡πâ‡∏≤‡∏á admin ‡πÉ‡∏´‡∏°‡πà
7. ‡∏•‡∏ö OTP record
8. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö
```

## üß™ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö

### 1. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á OTP
```bash
# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á OTP
curl -X POST https://www.b2b.winrichdynamic.com/api/adminb2b/register/send-otp \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "phone": "0812345678",
    "email": "test@example.com",
    "company": "Test Company",
    "role": "admin"
  }'
```

### 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
```bash
# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP
curl -X POST https://www.b2b.winrichdynamic.com/api/adminb2b/register/verify-otp \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "phone": "0812345678",
    "email": "test@example.com",
    "company": "Test Company",
    "role": "admin",
    "otp": "123456"
  }'
```

## üìä ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Logs

### Logs ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á OTP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
```
[B2B] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OTP ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
[B2B] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• OTP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
[B2B] Registration OTP sent to 66812345678: 123456
```

### Logs ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
```
[B2B] New admin registered: Test User (66812345678)
```

## üîß ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Railway

‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Environment Variables ‡πÉ‡∏ô Railway:

1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Railway Dashboard
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å B2B Service
3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Variables tab
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡πÄ‡∏û‡∏¥‡πà‡∏°:
   - `MONGODB_URI`
   - `DEESMSX_API_KEY`
   - `DEESMSX_SECRET_KEY`
   - `DEESMSX_SENDER_NAME`
   - `DEESMSX_BASE_URL`

## üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

1. **‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**: ‡πÉ‡∏ä‡πâ MongoDB ‡πÅ‡∏ó‡∏ô global cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
2. **TTL Index**: OTP ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
3. **Token vs Ref**: ‡πÉ‡∏ä‡πâ token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö verifyOTP ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ref
4. **Error Handling**: ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô

## üöÄ ‡∏Å‡∏≤‡∏£ Deploy

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß:

1. Commit ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
2. Push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á repository
3. Railway ‡∏à‡∏∞ deploy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö logs ‡πÉ‡∏ô Railway ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ

## üìû ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠

‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á:
- Error logs
- Environment variables ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° sensitive data)
- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥
